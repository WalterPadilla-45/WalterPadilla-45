generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")  
}

//////////////////////
// 1. USUARIOS
//////////////////////

model Usuario {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?   // HASH bcrypt (solo para Credentials)
  nombre        String?
  rol           Rol
  creadoEn      DateTime  @default(now())

  // Relaciones
  encuestas     Encuesta[]
  votos         Voto[]
  donaciones    Donacion[]
  accounts      Account[]
  sessions      Session[]
}

enum Rol {
  SUPER_USUARIO
  ACCIONISTA
  PUBLICO
}

//////////////////////
// 2. NEXTAUTH (OFICIAL)
//////////////////////

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

//////////////////////
// 3. ENCUESTAS
//////////////////////

// NUEVO: Enum para manejar el ciclo de vida de la encuesta
enum EstadoEncuesta {
  BORRADOR
  ACTIVA
  CERRADA
}

model Encuesta {
  id            String         @id @default(uuid())
  titulo        String
  descripcion   String?
  imagen        String?        // NUEVO: Imagen de portada
  slug          String         @unique
  
  // CAMBIO: Reemplazamos 'activa Boolean' por 'estado'
  estado        EstadoEncuesta @default(BORRADOR) 

  fechaInicio   DateTime       @default(now())
  fechaFin      DateTime?

  creadorId     String
  creador       Usuario        @relation(fields: [creadorId], references: [id])

  creadoEn      DateTime       @default(now())
  actualizadoEn DateTime       @updatedAt

  preguntas     Pregunta[]
  votos         Voto[]
  resultados    Resultado[]

  @@index([fechaInicio, fechaFin])
}

//////////////////////
// 4. PREGUNTAS
//////////////////////

model Pregunta {
  id          String       @id @default(uuid())
  texto       String
  imagen      String?      // NUEVO: Imagen de contexto para la pregunta
  tipo        TipoPregunta
  orden       Int
  obligatoria Boolean      @default(true)

  minValor    Int?
  maxValor    Int?

  encuestaId  String
  encuesta    Encuesta     @relation(fields: [encuestaId], references: [id], onDelete: Cascade)

  opciones    Opcion[]
}

enum TipoPregunta {
  OPCION_MULTIPLE
  TEXTO_ABIERTO
  CALIFICACION
}

//////////////////////
// 5. OPCIONES
//////////////////////

model Opcion {
  id         String  @id @default(uuid())
  texto      String
  imagen     String? // NUEVO: Imagen para la opci√≥n (ej. foto candidato)
  orden      Int

  preguntaId String
  pregunta   Pregunta @relation(fields: [preguntaId], references: [id], onDelete: Cascade)
}

//////////////////////
// 6. VOTOS
//////////////////////

model Voto {
  id          String   @id @default(uuid())

  encuestaId  String
  encuesta    Encuesta @relation(fields: [encuestaId], references: [id], onDelete: Cascade)

  usuarioId   String?
  usuario     Usuario? @relation(fields: [usuarioId], references: [id])

  fingerprint String
  ip          String?

  pais        String?
  ciudad      String?
  dispositivo String?

  respuestas  Json
  creadoEn    DateTime @default(now())

  @@unique([encuestaId, fingerprint])
  @@index([pais, ciudad])
}

//////////////////////
// 7. RESULTADOS
//////////////////////

model Resultado {
  id         String  @id @default(uuid())

  encuestaId String
  encuesta   Encuesta @relation(fields: [encuestaId], references: [id], onDelete: Cascade)

  preguntaId String
  opcionId   String?

  total      Int     @default(0)

  @@unique([encuestaId, preguntaId, opcionId])
}

//////////////////////
// 8. DONACIONES
//////////////////////

model CausaDonacion {
  id          String   @id @default(uuid())
  titulo      String
  descripcion String?
  imagen      String?
  activa      Boolean  @default(true)

  creadoEn    DateTime @default(now())

  donaciones  Donacion[]
}

enum EstadoDonacion {
  PENDIENTE
  COMPLETADA
  FALLIDA
}

model Donacion {
  id            String         @id @default(uuid())

  causaId       String
  causa         CausaDonacion  @relation(fields: [causaId], references: [id])

  usuarioId     String?
  usuario       Usuario?       @relation(fields: [usuarioId], references: [id])

  monto         Float
  moneda        String         @default("USD")

  estado        EstadoDonacion @default(PENDIENTE)

  nombreDonante String?
  emailDonante  String?

  ip            String?
  pais          String?
  ciudad        String?

  creadoEn      DateTime       @default(now())
}